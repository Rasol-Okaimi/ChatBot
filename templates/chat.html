<!DOCTYPE html>
<html>
<head>
    <title>Chat Web App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #e8f0fe;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #chat-box {
            border: 2px solid #4285f4;
            border-radius: 8px;
            padding: 15px;
            width: 600px;
            height: 450px;
            overflow-y: scroll;
            background: white;
            white-space: pre-wrap;
            box-shadow: 0 4px 6px rgba(66, 133, 244, 0.3);
            margin-bottom: 10px;
        }
        #input-area {
            display: flex;
            width: 600px;
            margin-bottom: 10px;
        }
        #user-input {
            flex: 1;
            padding: 10px;
            font-size: 16px;
            border: 2px solid #4285f4;
            border-radius: 6px 0 0 6px;
            outline: none;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        #user-input:focus {
            border-color: #3367d6;
        }
        #send-btn {
            background-color: #34a853;
            color: white;
            border: none;
            border-radius: 0 6px 6px 0;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: background-color 0.3s;
        }
        #send-btn:hover {
            background-color: #2c8c45;
        }
        #buttons-row {
            display: flex;
            width: 600px;
            justify-content: flex-start;
        }
        #buttons-row button {
            flex: 1;
            margin: 0 5px 0 0;
            padding: 10px 0;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: background-color 0.3s;
        }
        #save-log-btn {
            background-color: #fbbc05;
            color: #333;
        }
        #save-log-btn:hover {
            background-color: #d4a504;
            color: #222;
        }
        #print-btn {
            background-color: #ea4335;
        }
        #print-btn:hover {
            background-color: #c33227;
        }
        .message {
            margin: 6px 0;
        }
        .user {
            color: #1a73e8;
            font-weight: bold;
        }
        .bot {
            color: #188038;
        }
        a.download-link {
            color: #188038;
            text-decoration: underline;
            cursor: pointer;
        }
        /* Responsive for smaller screens */
        @media (max-width: 640px) {
            #chat-box, #input-area, #buttons-row {
                width: 90vw;
            }
            #user-input {
                font-size: 14px;
            }
            #buttons-row button {
                font-size: 14px;
                margin: 0 3px 0 0;
            }
        }
    </style>
</head>
<body>

<h2>Chat with Bot</h2>

<div id="chat-box"></div>

<div id="input-area">
    <input type="text" id="user-input" placeholder="Type your message...">
    <button id="send-btn">Send</button>
</div>

<div id="buttons-row">
    <button id="save-log-btn">Save Chat Log</button>
    <button id="print-btn">Print Chat</button>
</div>

<script>
const chatBox = document.getElementById("chat-box");
const userInput = document.getElementById("user-input");
const sendBtn = document.getElementById("send-btn");
const saveLogBtn = document.getElementById("save-log-btn");
const printBtn = document.getElementById("print-btn");

let idleTimer = null;
const IDLE_TIME = 30000; // 30 seconds

function resetIdleTimer() {
    if (idleTimer) clearTimeout(idleTimer);
    idleTimer = setTimeout(fetchSuggestions, IDLE_TIME);
}

function appendMessage(sender, text) {
    const div = document.createElement("div");
    div.classList.add("message");
    div.classList.add(sender);

    if (sender === "bot" && text.includes("Chat log saved to: ")) {
        const prefix = "Chat log saved to: ";
        const startIdx = text.indexOf(prefix) + prefix.length;
        const filename = text.substring(startIdx).trim();

        div.innerText = prefix;

        const link = document.createElement("a");
        link.href = "/download_log?path=" + encodeURIComponent(filename);
        link.innerText = filename;
        link.classList.add("download-link");
        link.target = "_blank";

        div.appendChild(link);
    } else {
        div.innerText = text;
    }

    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
}

function sendMessage(message) {
    if (message === "") return;
    appendMessage("user", "You: " + message);
    userInput.value = "";
    resetIdleTimer();

    fetch("/send_message", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "message=" + encodeURIComponent(message)
    })
    .then(response => response.json())
    .then(data => {
        appendMessage("bot", data.response);
        resetIdleTimer();
    });
}

function fetchSuggestions() {
    fetch("/get_suggestions")
    .then(response => response.json())
    .then(data => {
        if (data.tips && data.tips.length) {
            appendMessage("bot", "ðŸ’¡ Tips:\n" + data.tips.join("\n"));
        }
        if (data.questions && data.questions.length) {
            let suggestionsText = "â“ Suggested questions:\n";
            data.questions.forEach((q, i) => {
                suggestionsText += `${i+1}. ${q}\n`;
            });
            appendMessage("bot", suggestionsText);
        }
        resetIdleTimer();
    })
    .catch(() => {
        // ignore errors silently
        resetIdleTimer();
    });
}

sendBtn.addEventListener("click", () => {
    const message = userInput.value.trim();
    sendMessage(message);
});

userInput.addEventListener("keypress", function(e) {
    if (e.key === "Enter") sendBtn.click();
});

userInput.addEventListener("input", resetIdleTimer); // reset timer on typing

saveLogBtn.addEventListener("click", () => {
    sendMessage("save log");
});

printBtn.addEventListener("click", () => {
    window.print();
});

// Start idle timer when page loads
resetIdleTimer();

</script>

</body>
</html>
